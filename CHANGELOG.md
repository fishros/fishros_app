# 更新日志 - 虚拟摇杆控制

## 📅 更新时间
2026年2月3日

## ✨ 主要更新

### 1. 主控页面改用虚拟摇杆控制

**之前**: 四个独立按钮（前进/后退/左转/右转）

**现在**: 两个虚拟摇杆
- **左侧摇杆**: 控制线速度（X/Y 方向）
  - 前后移动控制 X 轴速度
  - 左右移动控制 Y 轴速度
  - 支持全向移动（需要机器人支持）
  
- **右侧摇杆**: 控制角速度（Z 轴旋转）
  - 左右移动控制旋转速度
  - 更精细的转向控制

### 2. 改进的速度控制

**新增功能**:
- 连续速度控制（不再是开关式）
- 实时速度反馈显示（VX, VY, ωZ）
- 支持同时控制线速度和角速度
- 摇杆松开自动归零

**ViewModel 更新**:
```kotlin
// 新增方法支持 X/Y 线速度 + Z 角速度
fun setVelocityXYZ(linearX: Double, linearY: Double, angularZ: Double)
```

**消息发布**:
```json
{
  "op": "publish",
  "topic": "/cmd_vel",
  "type": "geometry_msgs/Twist",
  "msg": {
    "linear": {"x": vx, "y": vy, "z": 0},
    "angular": {"x": 0, "y": 0, "z": wz}
  }
}
```

### 3. 连接页面支持滚动

**问题**: 小屏幕设备上元素可能被遮挡

**解决方案**:
- 添加 `verticalScroll` 修饰符
- 页面内容可上下滚动
- 适配各种屏幕尺寸

**代码变更**:
```kotlin
Column(
    modifier = Modifier
        .fillMaxSize()
        .verticalScroll(rememberScrollState()) // 新增滚动支持
        .padding(32.dp),
    // ...
)
```

### 4. 主页卡片尺寸优化

**之前**: 
- 正方形卡片（aspectRatio = 1f）
- 占用空间较大
- 图标 40sp，标题 28sp

**现在**:
- 固定高度 200dp
- 左右间距优化为 24dp
- 图标 32sp，标题 22sp
- 整体更紧凑、更适合横屏

**尺寸对比**:
| 元素 | 之前 | 现在 |
|------|------|------|
| 卡片形状 | 正方形 | 200dp高 |
| 图标大小 | 40sp | 32sp |
| 图标背景 | 80dp | 64dp |
| 标题大小 | 28sp | 22sp |
| 描述大小 | 14sp | 12sp |
| 间距 | 32dp | 24dp |

## 🎮 虚拟摇杆组件

### 特性
- ✅ 圆形可视化摇杆
- ✅ 半透明外圈和十字参考线
- ✅ 蓝色渐变手柄
- ✅ 自动边界限制
- ✅ 实时位置反馈
- ✅ 平滑的触控体验

### 使用方法

```kotlin
VirtualJoystick(
    size = 180f,  // 摇杆大小（dp）
    onMove = { x, y ->
        // x, y 范围: -1.0 ~ 1.0
        // x: 负值向左，正值向右
        // y: 负值向下，正值向上
        updateVelocity(x, y)
    },
    onRelease = {
        // 摇杆释放，停止移动
        stopMovement()
    }
)
```

### 视觉设计
- 外圈：白色半透明描边
- 活动区：蓝色半透明圆
- 十字线：白色参考线
- 手柄：实心蓝色圆 + 白色描边
- 连接线：蓝色半透明线（拖动时显示）

## 📱 UI 改进总结

### 连接页面
- ✅ 支持垂直滚动
- ✅ 小屏幕设备友好
- ✅ 所有元素可访问

### 主页
- ✅ 卡片尺寸优化
- ✅ 横屏布局更合理
- ✅ 视觉层级清晰

### 主控页面
- ✅ 双摇杆布局
- ✅ 实时速度显示
- ✅ 更精确的控制
- ✅ 支持全向移动

## 🔧 技术细节

### 坐标系统
```
虚拟摇杆输出:
  Y轴: 上(+1) -> 下(-1)
  X轴: 左(-1) -> 右(+1)

ROS cmd_vel:
  linear.x: 前进(+) / 后退(-)
  linear.y: 左(+) / 右(-) （全向轮机器人）
  angular.z: 逆时针(+) / 顺时针(-)

映射关系:
  摇杆Y -> linear.x (反转)
  摇杆X -> linear.y
  摇杆X -> angular.z (右摇杆)
```

### 速度控制逻辑
1. **移动时**: 以10Hz频率持续发布速度
2. **释放时**: 立即发送零速度并停止发布
3. **切换时**: 自动处理速度平滑过渡
4. **暂停时**: 应用暂停自动发送零速度

### 文件变更清单

**新增文件**:
- `ui/components/VirtualJoystick.kt` - 虚拟摇杆组件

**修改文件**:
- `ui/screens/ControlScreen.kt` - 替换按钮为摇杆
- `ui/screens/ConnectionScreen.kt` - 添加滚动支持
- `ui/screens/HomeScreen.kt` - 优化卡片尺寸
- `viewmodel/RosViewModel.kt` - 新增 `setVelocityXYZ()` 方法

## 🎯 使用建议

### 适合场景
- ✅ 需要精细速度控制
- ✅ 全向轮机器人
- ✅ 需要边移动边转向
- ✅ 习惯游戏摇杆操作

### 控制技巧
1. **单独移动**: 只推左摇杆
2. **单独转向**: 只推右摇杆
3. **边移边转**: 同时操作两个摇杆
4. **快速停止**: 松开所有摇杆

### 参数调节
在设置页面可以调整：
- 最大线速度（影响左摇杆灵敏度）
- 最大角速度（影响右摇杆灵敏度）

## 🐛 已知问题

### 兼容性
- ✅ 支持差速驱动机器人（只用线速度X和角速度Z）
- ✅ 支持全向轮机器人（使用线速度X/Y和角速度Z）
- ⚠️ 不支持阿克曼转向（需要特殊控制）

### 建议
- 根据机器人类型选择合适的控制模式
- 全向轮机器人可充分利用Y轴速度
- 差速驱动机器人建议只使用X轴（前后推动左摇杆）

## 📝 后续计划

### 短期优化
- [ ] 添加摇杆死区配置
- [ ] 支持速度曲线调节（线性/指数）
- [ ] 摇杆触觉反馈
- [ ] 自定义摇杆大小

### 长期功能
- [ ] 多种控制模式切换
- [ ] 自定义按键映射
- [ ] 蓝牙手柄支持
- [ ] 录制回放功能

---

**升级完成！享受更流畅的控制体验！** 🎮✨
